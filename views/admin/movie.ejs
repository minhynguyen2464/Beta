<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Admin Panel</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
        integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/admin.css">
</head>

<body>

    <nav class="navbar navbar-dark bg-dark">
        <span class="navbar-brand mb-0 h1">Admin Panel</span>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <nav class="col-md-2 d-none d-md-block bg-light sidebar">
                <div class="sidebar-sticky">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" href="#">
                                Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">
                                Users
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">
                                Products
                            </a>
                        </li>
                        <!-- Add more menu items as needed -->
                    </ul>
                </div>
            </nav>

            <main role="main" class="col-md-9 ml-sm-auto col-lg-10 px-md-4">
                <!-- Main content goes here -->
                <h1 class="row justify-content-center">Movie Form</h1>
                <div class="row justify-content-center">
                    <form enctype="multipart/form-data" class="movie-form" id="movieForm">
                        <!-- Movie Title -->
                        <div class="form-group">
                            <label for="title">Title:</label>
                            <input type="text" class="form-control" id="title" name="title" required>
                        </div>

                        <!-- Director -->
                        <div class="form-group">
                            <label for="director">Director:</label>
                            <input type="text" class="form-control" id="director" name="director" required>
                        </div>

                        <!-- Cast -->
                        <div class="form-group">
                            <label for="cast">Cast (comma-separated):</label>
                            <input type="text" class="form-control" id="cast" name="cast" required>
                        </div>

                        <!-- Genre (comma-separated) -->
                        <div class="form-group">
                            <label for="genre">Genre (comma-separated):</label>
                            <input type="text" class="form-control" id="genre" name="genre" required>
                        </div>

                        <!-- Duration (in minutes) -->
                        <div class="form-group">
                            <label for="duration">Duration (minutes):</label>
                            <input type="number" class="form-control" id="duration" name="duration" required>
                        </div>

                        <!-- Language -->
                        <div class="form-group">
                            <label for="language">Language:</label>
                            <input type="text" class="form-control" id="language" name="language" required>
                        </div>

                        <!-- Release Year -->
                        <div class="form-group">
                            <label for="releaseYear">Release Year:</label>
                            <input type="date" class="form-control" id="releaseYear" name="releaseYear" required>
                        </div>
                        <div class="form-group">
                            <label for="description">Movie Description:</label>
                            <textarea class="form-control" id="description" name="description" rows="3"
                                required></textarea>
                        </div>
                        <!-- Movie Poster -->
                        <div class="form-group">
                            <label for="poster">Movie Poster:</label>
                            <input type="file" class="form-control-file" id="poster" name="poster" accept="image/*">
                        </div>

                        <!-- Submit Button -->
                        <button type="submit" class="btn btn-primary">Thêm phim</button>
                        <button type="button" id="update" class="btn btn-warning" style="float:right">Cập nhật</button>
                    </form>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <div class="white_shd">
                            <div class="graph_head">
                                <h2>Movie</h2>
                            </div <div class="table_section padding_infor_info">
                            <div class="table-responsive-sm">
                                <table class="table" id="moviesTable">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th></th>
                                            <th></th>
                                            <th>Title</th>
                                            <th>Director</th>
                                            <th>Cast</th>
                                            <th>Genre</th>
                                            <th>Duration (min)</th>
                                            <th>Language</th>
                                            <th>Release Year</th>
                                            <th>Description</th>
                                            <th>Poster</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Example row (replace with dynamic data) -->
                                        
                                        <!-- Repeat the above row structure for each movie -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
        </div>
        </main>
    </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        const form = document.getElementById('movieForm');
        form.addEventListener('submit', function (e) {
            e.preventDefault();
            const formData = {
                title: document.getElementById('title').value,
                director: document.getElementById('director').value,
                cast: document.getElementById('cast').value,
                genre: document.getElementById('genre').value,
                duration: document.getElementById('duration').value,
                language: document.getElementById('language').value,
                releaseYear: document.getElementById('releaseYear').value,
                description: document.getElementById('description').value,
                poster: document.getElementById('poster').files[0], // Assuming file input for poster
            };
            axios.post('/admin/api/movie', formData, {
                headers: {
                    'Content-Type': 'multipart/form-data'
                }
            })
                .then((res) => {
                    console.log('Response data:', res.data);
                    alert("Thêm phim thành công");
                    window.location.reload(true);
                })
                .catch((err) => {
                    console.log('Error:', err);
                })
        })
        axios.get('/admin/api/movie')
            .then(res => {
                const movies = res.data;
                renderMoviesTable(movies);
            })
            .catch(err => {
                console.error('Error fetching movies:', error);

            })

        function renderMoviesTable(movies) {
            const tableBody = document.querySelector('#moviesTable tbody');
            // Clear existing rows
            tableBody.innerHTML = '';

            // Loop through movies and add rows to the table
            movies.forEach(movie => {
                let movieID = '';
                const row = tableBody.insertRow();
                // Add cells with movie data
                const path = '../images/' + movie.poster
                // Create an <a> tag
                const link = document.createElement('a');
                link.href = './addShowtimes?movie='+movie._id;  // Set the href attribute to your desired URL
                link.innerHTML = '<i class="fa-solid fa-plus"></i>';  // Set the text content of the <a> tag
                link.className = 'btn btn-success edit-button';

                const deleteButton = document.createElement('p');
                //deleteButton.href = '';  // Set the href attribute to your desired URL
                deleteButton.innerHTML = '<i class="fa-solid fa-x"></i>';  // Set the text content of the <a> tag
                deleteButton.className = 'btn btn-danger edit-button';
                deleteButton.addEventListener('click',(e)=>{
                    if(confirm("Bạn có muốn xóa phim này không")){
                        axios.delete('./deleteMovie?movie='+movie._id)
                        .then((res)=>{
                            console.log(`Deleted post success`);
                            window.location.reload();
                        })
                        .catch((err)=>{
                            console.log(err);
                        })
                    }
                    
                })

                const updateButton = document.createElement('p');
                updateButton.innerHTML = '<i class="fa-solid fa-pen-to-square"></i>';  // Set the text content of the <a> tag
                updateButton.className = 'btn btn-warning edit-button';
                //Logic xử lý nếu user nhấn update button
                updateButton.addEventListener('click',(e)=>{
                    axios.get('./getUpdateInfo?movie='+movie._id)
                    .then((res)=>{
                        const movie = res.data;
                        movieID = movie._id;
                        document.getElementById('title').value = movie.title;
                        document.getElementById('director').value = movie.director;
                        document.getElementById('cast').value = movie.cast.join(', ');
                        document.getElementById('genre').value = movie.genre.join(', ');
                        document.getElementById('duration').value = movie.duration;
                        document.getElementById('language').value = movie.language;
                        //Format ngày để đem  vào input field
                        const releaseYearDate = new Date(movie.releaseYear);
                        const formattedReleaseYear = releaseYearDate.toISOString().split('T')[0];
                        document.getElementById('releaseYear').value = formattedReleaseYear;
                        //document.getElementById('releaseYear').value = movie.releaseYear;
                        document.getElementById('description').textContent = movie.description;

                    })
                    .catch((err)=>{
                        console.log(err);
                    })
                })

                //Logic xử lý nếu user nhấn update button
                updateSubmit = document.getElementById('update')
                updateSubmit.addEventListener('click',(e)=>{
                    if(movieID){
                        const formData = {
                            title: document.getElementById('title').value,
                            director: document.getElementById('director').value,
                            cast: document.getElementById('cast').value,
                            genre: document.getElementById('genre').value,
                            duration: document.getElementById('duration').value,
                            language: document.getElementById('language').value,
                            releaseYear: document.getElementById('releaseYear').value,
                            description: document.getElementById('description').value,
                        };
                        //Gửi put request bằng axios
                        axios.put('./updateMovie?movie='+movieID,formData)
                        .then((res)=>{
                            alert("Cập nhật thành công");
                            window.location.reload();
                        })
                        .catch((err)=>{
                            console.log(err);
                        })
                    }
                })

                // Insert the <a> tag into the first cell of the row
                row.insertCell().appendChild(link);
                row.insertCell().appendChild(deleteButton);
                row.insertCell().appendChild(updateButton);
                row.insertCell().textContent = movie.title;
                row.insertCell().textContent = movie.director;
                row.insertCell().textContent = movie.cast.join(', ');
                row.insertCell().textContent = movie.genre.join(', ');
                row.insertCell().textContent = movie.duration;
                row.insertCell().textContent = movie.language;
                row.insertCell().textContent = new Date(movie.releaseYear).toLocaleDateString();
                row.insertCell().textContent = movie.description;
                row.insertCell().innerHTML = `<img src="${path}" alt="Movie Poster" style="max-width: 100px;">`;
            });
        }
    </script>
</body>

</html>